<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”Ÿè‚–å½©ç¥¨åŠ©æ‰‹</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      width: 380px;
      min-height: 500px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
    }

    .container {
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
      color: white;
    }

    .zodiac-info {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .zodiac-icon {
      font-size: 32px;
    }

    .zodiac-name {
      font-size: 18px;
      font-weight: bold;
    }

    .fortune-info {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
    }

    .fortune-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
      color: white;
    }

    .fortune-row:last-child {
      margin-bottom: 0;
    }

    .lottery-section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .lottery-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .lottery-numbers {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-bottom: 15px;
      min-height: 40px;
    }

    .number-ball {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: white;
    }

    .red-ball {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
    }

    .blue-ball {
      background: linear-gradient(135deg, #4ecdc4, #44a08d);
    }

    .lottery-status {
      text-align: center;
      margin-bottom: 15px;
      font-size: 14px;
    }

    .purchased {
      color: #27ae60;
      font-weight: bold;
    }

    .not-purchased {
      color: #e74c3c;
    }

    .generate-btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .generate-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .generate-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .footer {
      text-align: center;
      color: rgba(255, 255, 255, 0.8);
      font-size: 12px;
      margin-top: 10px;
    }

    /* åˆ†ç±»é€‰æ‹©å™¨æ ·å¼ */
    .category-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
    }

    .category-btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 25px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .category-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .category-btn.active {
      background: white;
      color: #667eea;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* é¡µé¢åˆ‡æ¢æ ·å¼ */
    .lottery-page {
      transition: all 0.3s ease;
    }

    .lottery-page.hidden {
      display: none;
    }

    /* å†å²è®°å½•æ ·å¼ */
    .recent-numbers, .personal-history {
      margin-top: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
    }

    .history-comparison {
      margin-top: 15px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }

    .section-title {
      font-size: 14px;
      font-weight: bold;
      color: #333;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .recent-list, .history-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .integrated-history {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .period-group {
      margin-bottom: 12px;
    }

    .period-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 8px;
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .period-header.pending {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      color: #8b4513;
    }

    .period-numbers {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .personal-record {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: white;
      border-radius: 6px;
      border-left: 3px solid #e9ecef;
      margin-bottom: 2px;
      font-size: 12px;
    }

    .personal-record.purchased {
      border-left-color: #28a745;
    }

    .personal-record.winner {
      border-left-color: #ffc107;
      background: #fff8e1;
    }

    .record-date {
      color: #6c757d;
      font-weight: 500;
      min-width: 60px;
    }

    .record-numbers {
      display: flex;
      align-items: center;
      gap: 2px;
      flex: 1;
      margin: 0 8px;
    }

    .record-status {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
    }

    .star-icon {
      color: #ffc107;
      font-size: 14px;
    }

    .prize-badge {
      background: #ffc107;
      color: #8b4513;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 600;
    }

    .recent-item, .history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: white;
      border-radius: 6px;
      font-size: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .recent-date, .history-date {
      color: #666;
      font-size: 11px;
    }

    .recent-numbers-display, .history-numbers-display {
      display: flex;
      gap: 3px;
    }

    .mini-ball {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      color: white;
    }

    .mini-red-ball {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
    }

    .mini-blue-ball {
      background: linear-gradient(135deg, #4ecdc4, #44a08d);
    }

    .prize-info {
      color: #e74c3c;
      font-weight: bold;
      font-size: 11px;
    }

    .no-data {
      text-align: center;
      color: #999;
      font-size: 12px;
      padding: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- å¤´éƒ¨ä¿¡æ¯ -->
    <div class="header">
      <div class="zodiac-info">
        <span class="zodiac-icon" id="zodiacIcon">ğŸ‰</span>
        <span class="zodiac-name" id="zodiacName">é¾™</span>
        <span>å¹´è¿åŠ¿</span>
      </div>
    </div>

    <!-- è¿åŠ¿ä¿¡æ¯ -->
    <div class="fortune-info">
      <div class="fortune-row">
        <span>å†œå†:</span>
        <span id="lunarDate">è…Šæœˆåˆå…«</span>
      </div>
      <div class="fortune-row">
        <span>ä»Šæ—¥:</span>
        <span id="lunarSuit">å®œ: ç¥ˆç¦ã€å‡ºè¡Œ å¿Œ: åŠ¨åœŸ</span>
      </div>
    </div>

    <!-- å½©ç¥¨åˆ†ç±»é€‰æ‹©å™¨ -->
    <div class="category-selector">
      <button class="category-btn active" data-category="welfare">ğŸˆ ç¦å½©</button>
      <button class="category-btn" data-category="sports">âš½ ä½“å½©</button>
    </div>

    <!-- ç¦å½©é¡µé¢ -->
    <div class="lottery-page" id="welfarePage">
      <!-- åŒè‰²çƒ -->
      <div class="lottery-section">
        <div class="lottery-title">
          ğŸ”´ åŒè‰²çƒ
        </div>
        <div class="lottery-numbers" id="ssqNumbers">
          <!-- å·ç çƒå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="lottery-status" id="ssqStatus">
          <!-- çŠ¶æ€ä¿¡æ¯ -->
        </div>
        <button class="generate-btn" id="ssqBtn">ç”Ÿæˆä»Šæ—¥å¹¸è¿å·ç </button>
        
        <!-- å†å²è®°å½•å¯¹æ¯” -->
        <div class="history-comparison">
          <div class="section-title">ğŸ“Š å†å²è®°å½•å¯¹æ¯”</div>
          <div class="integrated-history" id="ssqIntegratedHistory"></div>
        </div>
      </div>
    </div>

    <!-- ä½“å½©é¡µé¢ -->
    <div class="lottery-page hidden" id="sportsPage">
      <!-- å¤§ä¹é€ -->
      <div class="lottery-section">
        <div class="lottery-title">
          ğŸ¯ å¤§ä¹é€
        </div>
        <div class="lottery-numbers" id="dltNumbers">
          <!-- å·ç çƒå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="lottery-status" id="dltStatus">
          <!-- çŠ¶æ€ä¿¡æ¯ -->
        </div>
        <button class="generate-btn" id="dltBtn">ç”Ÿæˆä»Šæ—¥å¹¸è¿å·ç </button>
        
        <!-- å†å²è®°å½•å¯¹æ¯” -->
        <div class="history-comparison">
          <div class="section-title">ğŸ“Š å†å²è®°å½•å¯¹æ¯”</div>
          <div class="integrated-history" id="dltIntegratedHistory"></div>
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨ -->
    <div class="footer">
      ğŸ€ æ„¿å¥½è¿å¸¸ä¼´ ğŸ€
    </div>
  </div>

  <script type="module">
    let Lunar, Solar;
    
    // å¼‚æ­¥åˆå§‹åŒ–lunar-javascriptåº“
    async function initLunarLibrary() {
      try {
        const lunarModule = await import('https://cdn.skypack.dev/lunar-javascript');
        Lunar = lunarModule.Lunar;
        Solar = lunarModule.Solar;
        return true;
      } catch (error) {
        console.error('Failed to load lunar-javascript:', error);
        // æä¾›é™çº§æ–¹æ¡ˆ
        const fallbackZodiac = ['é¼ ', 'ç‰›', 'è™', 'å…”', 'é¾™', 'è›‡', 'é©¬', 'ç¾Š', 'çŒ´', 'é¸¡', 'ç‹—', 'çŒª'];
        const currentYear = new Date().getFullYear();
        const zodiacIndex = (currentYear - 1900) % 12;
        
        // æ¨¡æ‹Ÿlunar-javascriptçš„åŸºæœ¬åŠŸèƒ½
        Solar = {
          fromDate: () => ({
            getLunar: () => ({
              getYear: () => currentYear,
              getMonthInChinese: () => 'è…Š',
              getDayInChinese: () => 'åˆå…«',
              getDayYi: () => ['ç¥ˆç¦', 'å‡ºè¡Œ', 'å«å¨¶'],
              getDayJi: () => ['åŠ¨åœŸ', 'å¼€ä»“']
            })
          })
        };
        return false;
      }
    }

    // ç”Ÿè‚–æ˜ å°„
    const ZODIAC_ICONS = ['ğŸ­', 'ğŸ®', 'ğŸ¯', 'ğŸ°', 'ğŸ‰', 'ğŸ', 'ğŸ´', 'ğŸ‘', 'ğŸµ', 'ğŸ”', 'ğŸ¶', 'ğŸ·'];
    const ZODIAC_NAMES = ['é¼ ', 'ç‰›', 'è™', 'å…”', 'é¾™', 'è›‡', 'é©¬', 'ç¾Š', 'çŒ´', 'é¸¡', 'ç‹—', 'çŒª'];

    // ç»Ÿä¸€å­˜å‚¨é”®
    const STORAGE_KEY = 'lottery_data_unified';
    
    // å½©ç¥¨ç±»å‹å¸¸é‡
    const LOTTERY_TYPES = {
      SSQ: 'ssq',
      DLT: 'dlt'
    };

    /**
     * è·å–ä»Šæ—¥æ—¥æœŸå­—ç¬¦ä¸² (YYYY-MM-DD)
     */
    function getTodayString() {
      return new Date().toISOString().split('T')[0];
    }

    /**
     * åŸºäºç§å­çš„ç¡®å®šæ€§éšæœºæ•°ç”Ÿæˆå™¨
     */
    class SeededRandom {
      constructor(seed) {
        this.seed = seed;
      }

      next() {
        this.seed = (this.seed * 9301 + 49297) % 233280;
        return this.seed / 233280;
      }

      nextInt(min, max) {
        return Math.floor(this.next() * (max - min + 1)) + min;
      }
    }

    /**
     * ç”Ÿæˆç§å­å€¼
     */
    function generateSeed(lotteryType, date, zodiacIndex) {
      const str = `${lotteryType}-${date}-${zodiacIndex}`;
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return Math.abs(hash);
    }

    /**
     * ç”ŸæˆåŒè‰²çƒå·ç 
     * çº¢çƒ: 1-33é€‰6ä¸ªï¼Œè“çƒ: 1-16é€‰1ä¸ª
     */
    function generateSSQNumbers(seed) {
      if (typeof seed !== 'number' || seed < 0) {
        throw new Error('Invalid seed for SSQ number generation');
      }
      
      const rng = new SeededRandom(seed);
      const red = [];
      let attempts = 0;
      const maxAttempts = 1000; // é˜²æ­¢æ— é™å¾ªç¯
      
      while (red.length < 6 && attempts < maxAttempts) {
        const num = rng.nextInt(1, 33);
        if (num >= 1 && num <= 33 && !red.includes(num)) {
          red.push(num);
        }
        attempts++;
      }
      
      if (red.length !== 6) {
        throw new Error('Failed to generate 6 unique red balls for SSQ');
      }
      
      red.sort((a, b) => a - b);
      
      const blueNum = rng.nextInt(1, 16);
      if (blueNum < 1 || blueNum > 16) {
        throw new Error('Invalid blue ball number generated for SSQ');
      }
      
      const blue = [blueNum];
      
      return { red, blue };
    }

    /**
     * ç”Ÿæˆå¤§ä¹é€å·ç 
     * å‰åŒº: 1-35é€‰5ä¸ªï¼ŒååŒº: 1-12é€‰2ä¸ª
     */
    function generateDLTNumbers(seed) {
      if (typeof seed !== 'number' || seed < 0) {
        throw new Error('Invalid seed for DLT number generation');
      }
      
      const rng = new SeededRandom(seed);
      const red = [];
      const blue = [];
      let attempts = 0;
      const maxAttempts = 1000; // é˜²æ­¢æ— é™å¾ªç¯
      
      // ç”Ÿæˆå‰åŒºå·ç  (1-35é€‰5ä¸ª)
      while (red.length < 5 && attempts < maxAttempts) {
        const num = rng.nextInt(1, 35);
        if (num >= 1 && num <= 35 && !red.includes(num)) {
          red.push(num);
        }
        attempts++;
      }
      
      if (red.length !== 5) {
        throw new Error('Failed to generate 5 unique front numbers for DLT');
      }
      
      red.sort((a, b) => a - b);
      
      // ç”ŸæˆååŒºå·ç  (1-12é€‰2ä¸ª)
      attempts = 0;
      while (blue.length < 2 && attempts < maxAttempts) {
        const num = rng.nextInt(1, 12);
        if (num >= 1 && num <= 12 && !blue.includes(num)) {
          blue.push(num);
        }
        attempts++;
      }
      
      if (blue.length !== 2) {
        throw new Error('Failed to generate 2 unique back numbers for DLT');
      }
      
      blue.sort((a, b) => a - b);
      
      return { red, blue };
    }

    /**
     * è·å–å½“å‰ç”Ÿè‚–ä¿¡æ¯
     */
    function getCurrentZodiac() {
      const today = Solar.fromDate(new Date());
      const lunar = today.getLunar();
      const zodiacIndex = (lunar.getYear() - 4) % 12;
      
      return {
        index: zodiacIndex,
        name: ZODIAC_NAMES[zodiacIndex],
        icon: ZODIAC_ICONS[zodiacIndex]
      };
    }

    /**
     * è·å–å†œå†ä¿¡æ¯
     */
    function getLunarInfo() {
      const today = Solar.fromDate(new Date());
      const lunar = today.getLunar();
      
      const lunarDate = `${lunar.getMonthInChinese()}æœˆ${lunar.getDayInChinese()}`;
      
      const yi = lunar.getDayYi();
      const ji = lunar.getDayJi();
      
      let suit = '';
      if (yi.length > 0) {
        suit += `å®œ: ${yi.slice(0, 3).join('ã€')}`;
      }
      if (ji.length > 0) {
        if (suit) suit += ' ';
        suit += `å¿Œ: ${ji.slice(0, 3).join('ã€')}`;
      }
      
      return { date: lunarDate, suit: suit || 'å¹³å®‰å‰æ—¥' };
    }

    /**
     * è·å–ç»Ÿä¸€å­˜å‚¨çš„å½©ç¥¨æ•°æ®
     */
    async function getUnifiedLotteryData() {
      try {
        // æ£€æŸ¥Chrome APIæ˜¯å¦å¯ç”¨
        if (!chrome || !chrome.storage || !chrome.storage.local) {
          console.warn('Chrome storage API not available, using localStorage fallback');
          const data = localStorage.getItem(STORAGE_KEY);
          return data ? JSON.parse(data) : [];
        }
        
        const result = await chrome.storage.local.get(STORAGE_KEY);
        return result[STORAGE_KEY] || [];
      } catch (error) {
        console.error('Error getting unified lottery data:', error);
        return [];
      }
    }

    /**
     * ä»ç»Ÿä¸€æ•°æ®ä¸­è·å–ä»Šæ—¥å·ç æ•°æ®
     */
    async function getStoredNumbers(lotteryType) {
      try {
        const allData = await getUnifiedLotteryData();
        const today = getTodayString();
        
        // æŸ¥æ‰¾ä»Šæ—¥å¯¹åº”å½©ç§çš„å·ç æ•°æ®
        const todayData = allData.find(item => 
          item.type === lotteryType && 
          item.date === today && 
          item.dataType === 'generated_numbers'
        );
        
        return todayData ? todayData.data : null;
      } catch (error) {
        console.error('Error getting stored numbers:', error);
        return null;
      }
    }

    /**
     * ä¿å­˜ç»Ÿä¸€å½©ç¥¨æ•°æ®åˆ°å­˜å‚¨
     */
    async function saveUnifiedLotteryData(data) {
      try {
        // æ£€æŸ¥Chrome APIæ˜¯å¦å¯ç”¨
        if (!chrome || !chrome.storage || !chrome.storage.local) {
          console.warn('Chrome storage API not available, using localStorage fallback');
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          return;
        }
        
        await chrome.storage.local.set({ [STORAGE_KEY]: data });
      } catch (error) {
        console.error('Error saving unified lottery data:', error);
        // é™çº§åˆ°localStorage
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        } catch (fallbackError) {
          console.error('Fallback storage also failed:', fallbackError);
        }
      }
    }

    /**
     * åŸºäºæœ€è¿‘å¼€å¥–æ•°æ®æ¸…ç†è¿‡æœŸç¼“å­˜
     */
    async function cleanExpiredCache(lotteryType) {
      try {
        const allData = await getUnifiedLotteryData();
        const winningData = await getRecentWinningNumbers(lotteryType);
        
        if (winningData.length === 0) return allData;
        
        // è·å–æœ€å°å¼€å¥–æ—¥æœŸ
        const minWinningDate = new Date(Math.min(...winningData.map(w => new Date(w.date))));
        
        // è¿‡æ»¤æ‰æ¯”æœ€å°å¼€å¥–æ—¥æœŸè¿˜è¦å°çš„æ•°æ®
        const filteredData = allData.filter(item => {
          if (item.type !== lotteryType) return true; // ä¿ç•™å…¶ä»–å½©ç§æ•°æ®
          
          const itemDate = new Date(item.date);
          return itemDate >= minWinningDate; // åªä¿ç•™ä¸æ—©äºæœ€å°å¼€å¥–æ—¥æœŸçš„æ•°æ®
        });
        
        return filteredData;
      } catch (error) {
        console.error('Error cleaning expired cache:', error);
        return await getUnifiedLotteryData(); // è¿”å›åŸæ•°æ®
      }
    }

    /**
     * ä¿å­˜å·ç æ•°æ®åˆ°ç»Ÿä¸€å­˜å‚¨
     */
    async function saveNumbers(lotteryType, numbers) {
      try {
        let allData = await getUnifiedLotteryData();
        const today = getTodayString();
        
        // æ¸…ç†è¿‡æœŸç¼“å­˜
        allData = await cleanExpiredCache(lotteryType);
        
        // ç§»é™¤ä»Šæ—¥åŒç±»å‹çš„æ—§æ•°æ®
        allData = allData.filter(item => 
          !(item.type === lotteryType && 
            item.date === today && 
            item.dataType === 'generated_numbers')
        );
        
        // æ·»åŠ æ–°æ•°æ®
        const newEntry = {
          type: lotteryType,
          date: today,
          dataType: 'generated_numbers',
          data: numbers,
          timestamp: Date.now()
        };
        
        allData.push(newEntry);
        
        // æŒ‰æ—¥æœŸå€’åºæ’åº
        allData.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        await saveUnifiedLotteryData(allData);
      } catch (error) {
        console.error('Error saving numbers:', error);
      }
    }

    /**
     * ç”Ÿæˆå¹¶ä¿å­˜å·ç 
     */
    async function generateAndSaveNumbers(lotteryType) {
      try {
        if (!lotteryType || (lotteryType !== 'ssq' && lotteryType !== 'dlt')) {
          throw new Error('Invalid lottery type: ' + lotteryType);
        }
        
        const zodiac = getCurrentZodiac();
        const today = getTodayString();
        const seed = generateSeed(lotteryType, today, zodiac.index);
        
        let numbers;
        if (lotteryType === 'ssq') {
          numbers = generateSSQNumbers(seed);
        } else {
          numbers = generateDLTNumbers(seed);
        }
        
        // éªŒè¯ç”Ÿæˆçš„å·ç 
        if (!numbers || !Array.isArray(numbers.red) || !Array.isArray(numbers.blue)) {
          throw new Error('Invalid numbers generated');
        }
        
        const lotteryNumbers = {
          red: numbers.red,
          blue: numbers.blue,
          generated: true,
          purchased: false,
          date: today
        };
        
        await saveNumbers(lotteryType, lotteryNumbers);
        return lotteryNumbers;
      } catch (error) {
        console.error('Error generating and saving numbers:', error);
        // è¿”å›ä¸€ä¸ªé”™è¯¯çŠ¶æ€çš„å¯¹è±¡
        return {
          red: [],
          blue: [],
          generated: false,
          purchased: false,
          date: getTodayString(),
          error: error.message
        };
      }
    }

    /**
     * æ¸²æŸ“å·ç çƒ
     */
    function renderNumbers(containerId, numbers, lotteryType) {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      if (!numbers.generated) {
        container.innerHTML = '';
        return;
      }
      
      let html = '';
      
      numbers.red.forEach(num => {
        html += `<span class="number-ball red-ball">${num.toString().padStart(2, '0')}</span>`;
      });
      
      html += '<span style="margin: 0 8px; font-size: 16px;">+</span>';
      
      numbers.blue.forEach(num => {
        html += `<span class="number-ball blue-ball">${num.toString().padStart(2, '0')}</span>`;
      });
      
      container.innerHTML = html;
    }

    /**
     * æ¸²æŸ“çŠ¶æ€
     */
    function renderStatus(statusId, numbers) {
      const statusEl = document.getElementById(statusId);
      if (!statusEl) return;
      
      if (numbers.error) {
        statusEl.innerHTML = '<span style="color: #e74c3c;">âš  ç”Ÿæˆå¤±è´¥ - è¯·é‡è¯•</span>';
        return;
      }
      
      if (!numbers.generated) {
        statusEl.innerHTML = '';
        return;
      }
      
      if (numbers.purchased) {
        statusEl.innerHTML = '<span class="purchased">âœ“ å·²è´­ä¹° - ç­‰å¾…å¼€å¥–</span>';
      } else {
        statusEl.innerHTML = '<span class="not-purchased">â—‹ æœªè´­ä¹° - ç‚¹å‡»è´­ä¹°</span>';
      }
    }

    /**
     * æ›´æ–°æŒ‰é’®çŠ¶æ€
     */
    function updateButton(buttonId, numbers) {
      const button = document.getElementById(buttonId);
      if (!button) return;
      
      if (numbers.generated) {
        button.textContent = numbers.purchased ? 'ä»Šæ—¥å·²ç”Ÿæˆ' : 'æ ‡è®°ä¸ºå·²è´­ä¹°';
        button.disabled = numbers.purchased;
      } else {
        button.textContent = 'ç”Ÿæˆä»Šæ—¥å¹¸è¿å·ç ';
        button.disabled = false;
      }
    }

    /**
     * å¤„ç†æŒ‰é’®ç‚¹å‡»
     */
    async function handleButtonClick(lotteryType) {
      const isSSQ = lotteryType === 'ssq';
      const buttonId = isSSQ ? 'ssqBtn' : 'dltBtn';
      const numbersId = isSSQ ? 'ssqNumbers' : 'dltNumbers';
      const statusId = isSSQ ? 'ssqStatus' : 'dltStatus';
      const historyId = isSSQ ? 'ssqIntegratedHistory' : 'dltIntegratedHistory';
      
      let numbers = await getStoredNumbers(lotteryType);
      
      if (!numbers || !numbers.generated) {
        numbers = await generateAndSaveNumbers(lotteryType);
      } else if (!numbers.purchased) {
        numbers.purchased = true;
        await saveNumbers(lotteryType, numbers);
        
        // æ·»åŠ åˆ°ä¸ªäººå†å²è®°å½•
        const history = await getPersonalHistory(lotteryType);
        const newRecord = {
          date: getTodayString(),
          red: numbers.red,
          blue: numbers.blue,
          prize: null // å¼€å¥–åæ‰çŸ¥é“æ˜¯å¦ä¸­å¥–
        };
        
        // å°†æ–°è®°å½•æ·»åŠ åˆ°å†å²è®°å½•å¼€å¤´
        history.unshift(newRecord);
        
        // åªä¿ç•™æœ€è¿‘10æ¡è®°å½•
        if (history.length > 10) {
          history.splice(10);
        }
        
        await savePersonalHistory(lotteryType, history);
        
        // é‡æ–°æ¸²æŸ“æ•´åˆå†å²è®°å½•
        await renderIntegratedHistory(historyId, lotteryType);
      }
      
      renderNumbers(numbersId, numbers, lotteryType);
      renderStatus(statusId, numbers);
      updateButton(buttonId, numbers);
    }

    /**
     * è·å–çœŸå®å†å²å¼€å¥–æ•°æ®
     */
    async function getRecentWinningNumbers(lotteryType) {
      // åŒè‰²çƒä½¿ç”¨çœŸå®ç¦å½©APIæ•°æ®
      if (lotteryType === 'ssq') {
        try {
          const response = await fetch('https://www.cwl.gov.cn/cwl_admin/front/cwlkj/search/kjxx/findDrawNotice?name=ssq&issueCount=5&issueStart=&issueEnd=&dayStart=&dayEnd=&pageNo=1&pageSize=5&week=&systemType=PC', {
            method: 'GET',
            headers: {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
              'Accept': '*/*',
              'Connection': 'keep-alive'
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          
          if (data.state === 0 && data.result && Array.isArray(data.result)) {
            return data.result.slice(0, 5).map(item => {
              // è§£æå¼€å¥–å·ç  "07,09,11,12,16,29" -> red: [7,9,11,12,16,29], blue: [15]
              const redNumbers = item.red.split(',').map(num => parseInt(num));
              const blueNumbers = [parseInt(item.blue)];
              
              return {
                period: parseInt(item.code), // æœŸå·
                date: item.date.split('(')[0], // å¼€å¥–æ—¥æœŸï¼Œå»æ‰æ˜ŸæœŸä¿¡æ¯
                red: redNumbers,
                blue: blueNumbers
              };
            });
          } else {
            throw new Error('ç¦å½©APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
          }
        } catch (error) {
          console.error('è·å–åŒè‰²çƒå¼€å¥–æ•°æ®å¤±è´¥:', error);
          
          // é™çº§åˆ°æ¨¡æ‹Ÿæ•°æ®
          const ssqData = [
            { period: 2025096, date: '2025-08-21', red: [7, 9, 11, 12, 16, 29], blue: [15] },
            { period: 2025095, date: '2025-08-19', red: [15, 16, 22, 23, 26, 32], blue: [4] },
            { period: 2025094, date: '2025-08-17', red: [11, 13, 17, 19, 23, 29], blue: [16] },
            { period: 2025093, date: '2025-08-14', red: [9, 11, 12, 24, 25, 26], blue: [10] },
            { period: 2025092, date: '2025-08-12', red: [2, 11, 14, 17, 23, 24], blue: [12] }
          ];
          return ssqData;
        }
      }
      
      // å¤§ä¹é€ä½¿ç”¨çœŸå®APIæ•°æ®
      try {
        const response = await fetch('https://webapi.sporttery.cn/gateway/lottery/getHistoryPageListV1.qry?gameNo=85&provinceId=0&pageSize=5&isVerify=1&pageNo=1&termLimits=5', {
          method: 'GET',
          headers: {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
            'Accept': '*/*',
            'Connection': 'keep-alive'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.value && data.value.list) {
          return data.value.list.map(item => {
            // è§£æå¼€å¥–å·ç  "04 09 17 30 33 05 09" -> red: [4,9,17,30,33], blue: [5,9]
            const numbers = item.lotteryDrawResult.split(' ').map(num => parseInt(num));
            const red = numbers.slice(0, 5); // å‰5ä¸ªæ˜¯çº¢çƒ
            const blue = numbers.slice(5, 7); // å2ä¸ªæ˜¯è“çƒ
            
            return {
              period: parseInt(item.lotteryDrawNum), // æœŸå·
              date: item.lotteryDrawTime, // å¼€å¥–æ—¥æœŸ
              red: red,
              blue: blue
            };
          });
        } else {
          throw new Error('APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
        }
      } catch (error) {
        console.error('è·å–å¤§ä¹é€å¼€å¥–æ•°æ®å¤±è´¥:', error);
        
        // é™çº§åˆ°æ¨¡æ‹Ÿæ•°æ®
        const dltData = [
          { period: 25094, date: '2025-08-18', red: [4, 9, 17, 30, 33], blue: [5, 9] },
          { period: 25093, date: '2025-08-15', red: [7, 14, 20, 27, 33], blue: [5, 11] },
          { period: 25092, date: '2025-08-13', red: [2, 9, 16, 23, 30], blue: [1, 7] },
          { period: 25091, date: '2025-08-10', red: [4, 11, 17, 24, 32], blue: [6, 9] },
          { period: 25090, date: '2025-08-08', red: [6, 13, 19, 26, 35], blue: [2, 12] }
        ];
        return dltData;
      }
    }

    /**
     * è·å–ä¸ªäººä¸­å¥–è®°å½•
     */
    async function getPersonalHistory(lotteryType) {
      try {
        const allData = await getUnifiedLotteryData();
        
        // æŸ¥æ‰¾å¯¹åº”å½©ç§çš„ä¸ªäººå†å²è®°å½•
        const historyEntries = allData.filter(item => 
          item.type === lotteryType && 
          item.dataType === 'personal_history'
        );
        
        // æŒ‰æ—¥æœŸå€’åºæ’åºå¹¶æå–æ•°æ®
        const history = historyEntries
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .map(item => item.data);
        
        return history;
      } catch (error) {
        console.error('Error getting personal history:', error);
        return [];
      }
    }

    /**
     * æ£€æµ‹ä¸­å¥–ç­‰çº§
     */
    function checkPrize(personalNumbers, winningNumbers, lotteryType) {
      if (!personalNumbers || !winningNumbers) return null;
      
      const redMatches = personalNumbers.red.filter(num => winningNumbers.red.includes(num)).length;
      const blueMatches = personalNumbers.blue.filter(num => winningNumbers.blue.includes(num)).length;
      
      if (lotteryType === 'ssq') {
        // åŒè‰²çƒä¸­å¥–è§„åˆ™
        if (redMatches === 6 && blueMatches === 1) return 'ä¸€ç­‰å¥–';
        if (redMatches === 6 && blueMatches === 0) return 'äºŒç­‰å¥–';
        if (redMatches === 5 && blueMatches === 1) return 'ä¸‰ç­‰å¥–';
        if (redMatches === 5 && blueMatches === 0) return 'å››ç­‰å¥–';
        if (redMatches === 4 && blueMatches === 1) return 'å››ç­‰å¥–';
        if (redMatches === 4 && blueMatches === 0) return 'äº”ç­‰å¥–';
        if (redMatches === 3 && blueMatches === 1) return 'äº”ç­‰å¥–';
        if (redMatches < 3 && blueMatches === 1) return 'å…­ç­‰å¥– 5å…ƒ';
        if (redMatches === 2 && blueMatches === 1) return 'å…­ç­‰å¥– 5å…ƒ';
        if (redMatches === 1 && blueMatches === 1) return 'å…­ç­‰å¥– 5å…ƒ';
        if (redMatches === 0 && blueMatches === 1) return 'å…­ç­‰å¥– 5å…ƒ';
      } else {
        // å¤§ä¹é€ä¸­å¥–è§„åˆ™
        if (redMatches === 5 && blueMatches === 2) return 'ä¸€ç­‰å¥–';
        if (redMatches === 5 && blueMatches === 1) return 'äºŒç­‰å¥–';
        if (redMatches === 5 && blueMatches === 0) return 'ä¸‰ç­‰å¥–';
        if (redMatches === 4 && blueMatches === 2) return 'å››ç­‰å¥–';
        if (redMatches === 4 && blueMatches === 1) return 'äº”ç­‰å¥–';
        if (redMatches === 3 && blueMatches === 2) return 'å…­ç­‰å¥–';
        if (redMatches === 4 && blueMatches === 0) return 'ä¸ƒç­‰å¥–';
        if (redMatches === 3 && blueMatches === 1) return 'å…«ç­‰å¥–';
        if (redMatches === 2 && blueMatches === 2) return 'å…«ç­‰å¥–';
        if (redMatches === 3 && blueMatches === 0) return 'ä¹ç­‰å¥– 5å…ƒ';
        if (redMatches === 1 && blueMatches === 2) return 'ä¹ç­‰å¥– 5å…ƒ';
        if (redMatches === 2 && blueMatches === 1) return 'ä¹ç­‰å¥– 5å…ƒ';
        if (redMatches === 0 && blueMatches === 2) return 'ä¹ç­‰å¥– 5å…ƒ';
      }
      
      return null;
    }



    /**
     * ä¿å­˜ä¸ªäººä¸­å¥–è®°å½•åˆ°ç»Ÿä¸€å­˜å‚¨
     */
    async function savePersonalHistory(lotteryType, history) {
      try {
        let allData = await getUnifiedLotteryData();
        const today = getTodayString();
        
        // æ¸…ç†è¿‡æœŸç¼“å­˜
        allData = await cleanExpiredCache(lotteryType);
        
        // ç§»é™¤è¯¥å½©ç§çš„æ—§å†å²è®°å½•æ•°æ®
        allData = allData.filter(item => 
          !(item.type === lotteryType && item.dataType === 'personal_history')
        );
        
        // ä¸ºæ¯æ¡å†å²è®°å½•åˆ›å»ºå•ç‹¬çš„å­˜å‚¨æ¡ç›®
        history.forEach(record => {
          const newEntry = {
            type: lotteryType,
            date: record.date,
            dataType: 'personal_history',
            data: record,
            timestamp: Date.now()
          };
          allData.push(newEntry);
        });
        
        // æŒ‰æ—¥æœŸå€’åºæ’åº
        allData.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        await saveUnifiedLotteryData(allData);
      } catch (error) {
        console.error('Error saving personal history:', error);
      }
    }

    /**
     * æ ¼å¼åŒ–æ—¥æœŸä¸ºMM-DDæ ¼å¼
     */
    function formatDateShort(dateStr) {
      const date = new Date(dateStr);
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const day = date.getDate().toString().padStart(2, '0');
      return `${month}-${day}`;
    }

    /**
     * æ¸²æŸ“æ•´åˆçš„å†å²è®°å½•å¯¹æ¯”
     */
    async function renderIntegratedHistory(containerId, lotteryType) {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      const winningData = await getRecentWinningNumbers(lotteryType);
      const personalHistory = await getPersonalHistory(lotteryType);
      
      if (winningData.length === 0) {
        container.innerHTML = '<div class="no-data">æš‚æ— å¼€å¥–æ•°æ®</div>';
        return;
      }
      
      let html = '';
      
      // æ·»åŠ å¾…å¼€å¥–æœŸå·
      const nextPeriod = winningData[0].period + 1;
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      
      html += '<div class="period-group">';
      html += `<div class="period-header pending">`;
      html += `<span>${nextPeriod} æœŸ <br/> &nbsp;${formatDateShort(todayStr)}</span>`;
      html += '<span>å¾…å¼€å¥–</span>';
      html += '</div>';
      
      // æ˜¾ç¤ºä»Šæ—¥çš„ä¸ªäººå·ç 
      const todayRecords = personalHistory.filter(record => record.date === todayStr);
      if (todayRecords.length > 0) {
        todayRecords.forEach(record => {
          html += '<div class="personal-record';
          if (record.purchased) html += ' purchased';
          html += '">';
          html += `<div class="record-date">${formatDateShort(record.date)}</div>`;
          html += '<div class="record-numbers">';
          
          record.red.forEach(num => {
            html += `<span class="mini-ball mini-red-ball">${num.toString().padStart(2, '0')}</span>`;
          });
          
          record.blue.forEach(num => {
            html += `<span class="mini-ball mini-blue-ball">${num.toString().padStart(2, '0')}</span>`;
          });
          
          html += '</div>';
          html += '<div class="record-status">';
          if (record.purchased) {
            html += '<span class="star-icon">â˜…</span>';
          }
          html += '</div>';
          html += '</div>';
        });
      } else {
        html += '<div class="personal-record">';
        html += `<div class="record-date">${formatDateShort(todayStr)}</div>`;
        html += '<div class="record-numbers">æš‚æ— å·ç </div>';
        html += '<div class="record-status"></div>';
        html += '</div>';
      }
      
      html += '</div>';
      
      // æ˜¾ç¤ºå†å²å¼€å¥–æœŸå·å’Œå¯¹åº”çš„ä¸ªäººå·ç 
      winningData.forEach(winning => {
        html += '<div class="period-group">';
        html += `<div class="period-header">`;
        html += `<span>${winning.period} æœŸ<br/> &nbsp;${formatDateShort(winning.date)}</span>`;
        html += '<div class="period-numbers">';
        
        winning.red.forEach(num => {
          html += `<span class="mini-ball mini-red-ball">${num.toString().padStart(2, '0')}</span>`;
        });
        
        winning.blue.forEach(num => {
          html += `<span class="mini-ball mini-blue-ball">${num.toString().padStart(2, '0')}</span>`;
        });
        
        html += '</div>';
        html += '</div>';
        
        // æŸ¥æ‰¾è¯¥å¼€å¥–æ—¥æœŸå‰åçš„ä¸ªäººå·ç 
        const winningDate = new Date(winning.date);
        const relevantRecords = personalHistory.filter(record => {
          const recordDate = new Date(record.date);
          const daysDiff = Math.abs((winningDate - recordDate) / (1000 * 60 * 60 * 24));
          return daysDiff <= 3; // å¼€å¥–æ—¥æœŸå‰å3å¤©å†…çš„è®°å½•
        }).slice(0, 3); // æœ€å¤šæ˜¾ç¤º3æ¡
        
        if (relevantRecords.length > 0) {
          relevantRecords.forEach(record => {
            const prize = checkPrize(record, winning, lotteryType);
            html += '<div class="personal-record';
            if (record.purchased) html += ' purchased';
            if (prize) html += ' winner';
            html += '">';
            html += `<div class="record-date">${formatDateShort(record.date)}</div>`;
            html += '<div class="record-numbers">';
            
            record.red.forEach(num => {
              html += `<span class="mini-ball mini-red-ball">${num.toString().padStart(2, '0')}</span>`;
            });
            
            record.blue.forEach(num => {
              html += `<span class="mini-ball mini-blue-ball">${num.toString().padStart(2, '0')}</span>`;
            });
            
            html += '</div>';
            html += '<div class="record-status">';
            if (record.purchased) {
              html += '<span class="star-icon">â˜…</span>';
            }
            if (prize) {
              html += `<span class="prize-badge">${prize}</span>`;
            }
            html += '</div>';
            html += '</div>';
          });
        }
        
        html += '</div>';
      });
      
      container.innerHTML = html;
    }

    /**
     * é¡µé¢åˆ‡æ¢åŠŸèƒ½
     */
    function initPageSwitcher() {
      const categoryBtns = document.querySelectorAll('.category-btn');
      const welfarePage = document.getElementById('welfarePage');
      const sportsPage = document.getElementById('sportsPage');
      
      categoryBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const category = btn.dataset.category;
          
          // æ›´æ–°æŒ‰é’®çŠ¶æ€
          categoryBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          // åˆ‡æ¢é¡µé¢
          if (category === 'welfare') {
            welfarePage.classList.remove('hidden');
            sportsPage.classList.add('hidden');
          } else {
            welfarePage.classList.add('hidden');
            sportsPage.classList.remove('hidden');
          }
        });
      });
    }

    /**
     * åˆå§‹åŒ–é¡µé¢
     */
    async function initPage() {
      // é¦–å…ˆåˆå§‹åŒ–lunaråº“
      await initLunarLibrary();
      
      // åˆå§‹åŒ–é¡µé¢åˆ‡æ¢å™¨
      initPageSwitcher();
      
      const zodiac = getCurrentZodiac();
      const zodiacIcon = document.getElementById('zodiacIcon');
      const zodiacName = document.getElementById('zodiacName');
      
      if (zodiacIcon) zodiacIcon.textContent = zodiac.icon;
      if (zodiacName) zodiacName.textContent = zodiac.name;
      
      const lunarInfo = getLunarInfo();
      const lunarDate = document.getElementById('lunarDate');
      const lunarSuit = document.getElementById('lunarSuit');
      
      if (lunarDate) lunarDate.textContent = lunarInfo.date;
      if (lunarSuit) lunarSuit.textContent = lunarInfo.suit;
      
      // æ¸²æŸ“æ•´åˆçš„å†å²è®°å½•
      await renderIntegratedHistory('ssqIntegratedHistory', 'ssq');
      await renderIntegratedHistory('dltIntegratedHistory', 'dlt');
      
      const ssqNumbers = await getStoredNumbers('ssq');
      const dltNumbers = await getStoredNumbers('dlt');
      
      if (ssqNumbers) {
        renderNumbers('ssqNumbers', ssqNumbers, 'ssq');
        renderStatus('ssqStatus', ssqNumbers);
        updateButton('ssqBtn', ssqNumbers);
      }
      
      if (dltNumbers) {
        renderNumbers('dltNumbers', dltNumbers, 'dlt');
        renderStatus('dltStatus', dltNumbers);
        updateButton('dltBtn', dltNumbers);
      }
      
      const ssqBtn = document.getElementById('ssqBtn');
      const dltBtn = document.getElementById('dltBtn');
      
      if (ssqBtn) {
        ssqBtn.addEventListener('click', () => handleButtonClick('ssq'));
      }
      
      if (dltBtn) {
        dltBtn.addEventListener('click', () => handleButtonClick('dlt'));
      }
    }

    document.addEventListener('DOMContentLoaded', initPage);
  </script>
</body>
</html>